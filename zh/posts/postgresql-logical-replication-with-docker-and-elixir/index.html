<!doctype html><html><head><title>PostgreSQL Logical Replication with Docker and Elixir | 码雾</title><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=keywords content="pg,elixir,docker"><meta name=description content="postgresql, logical replication, docker, elixir, wal2json"><link rel=stylesheet href=/lib/icofont/icofont.min.css><link rel=stylesheet href=/css/syntax.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-YEDG0XLC2T"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YEDG0XLC2T")</script><body><header class=header-wrapper><div class=header><a class=site-title href=https://www.peterlau.xyz>码雾</a><div class=menu><ul class=menu-left><li class=menu-item><a href=/posts/>Posts</a></li><li class=menu-item>"I saw the best minds of my generation destroyed by madness"</li></ul><div class=menu-right><li class=menu-item><a href>Contact</a></li></div></div></div></header><main class=main-wrapper><div class=main><section class=single><h1 class=title>PostgreSQL Logical Replication with Docker and Elixir</h1><div class=tip><time datetime="2022-09-29 00:00:00 +0000 UTC">2022/09/29</time>
<span class=split>·</span>
<span>619 words</span>
<span class=split>·</span>
<span>2 minutes to read</span></div><div class=taxonomies><div>Categories:
<a href=/categories/dev>dev</a></div><div>Tags:
<a href=/tags/pg>pg</a>
<a href=/tags/elixir>elixir</a>
<a href=/tags/docker>docker</a></div></div><hr><div class=content><h1 id=启动两个-pg-节点-using-docker-compose>启动两个 pg 节点 (using Docker Compose) <a href=#%e5%90%af%e5%8a%a8%e4%b8%a4%e4%b8%aa-pg-%e8%8a%82%e7%82%b9-using-docker-compose class=anchor>🔗</a></h1><p>(lr aka Logical Replication)
mkdir lr</p><p>mkdir -p pg1/{data,share} pg2/{data,share}</p><p>touch docker-compose.yml</p><p>content:</p><p>start compose:</p><p>docker-compose up</p><p>感谢 Debezium 的 <a href=https://github.com/debezium/container-images/tree/main/postgres/14-alpine>postgresql-alpine-with-wal2json image</a> 让安装 wal2json 很容易.</p><p>从容器中复制一份 pg_hba.conf.example 到 ./pg1/share/pg_hda.conf 和 ./pg2/share/pg_hda.conf</p><p>start a new terminal:</p><p>cd lr</p><p>docker cp lr-pg1-1:/usr/local/share/postgresql/pg_hba.conf.sample lr/pg1/share/pg_hba.conf</p><p>docker cp lr-pg1-1:/usr/local/share/postgresql/pg_hba.conf.sample lr/pg2/share/pg_hba.conf</p><p>末尾添加</p><p>host all repuser 0.0.0.0/0 md5</p><p>restart docker-compose</p><p>Ctrl-c</p><p>docker-compose up</p><p>查看 pg2 Log: docker-compose logs -f pg2</p><h1 id=logical-decoding>Logical Decoding <a href=#logical-decoding class=anchor>🔗</a></h1><h2 id=create-tables-and-data>Create tables and data <a href=#create-tables-and-data class=anchor>🔗</a></h2><p>In pg1 as publication</p><p>create database source_rep;
\c source_rep;
create table test_rep(id int primary key, name varchar);
create table test_rep_other(id int primary key, name varchar);
insert into test_rep values(generate_series(1,100),&lsquo;data&rsquo;||generate_series(1,100));
insert into test_rep_other values(generate_series(1,100),&lsquo;data&rsquo;||generate_series(1,100));
select count(1) from test_rep;
select count(1) from test_rep_other;</p><p>创建 PUBLICATION
CREATE PUBLICATION pub FOR TABLE test_rep, test_rep_other;</p><p>In pg2 as subscription</p><p>create database target_rep;
create table test_rep(id int primary key, name varchar);
create table test_rep_other(id int primary key, name varchar);</p><p>创建 SUBSCRIPTION</p><p>CREATE SUBSCRIPTION sub CONNECTION &lsquo;dbname=source_rep host=pg1 user=dev password=dev port=5432&rsquo; PUBLICATION pub;</p><p>一个常用语句 check solts</p><p>SELECT slot_name, plugin, slot_type, database, active, restart_lsn, confirmed_flush_lsn FROM pg_replication_slots;</p><h2 id=via-sql>via SQL: <a href=#via-sql class=anchor>🔗</a></h2><h2 id=via-pg_recvlogical>via pg_recvlogical: <a href=#via-pg_recvlogical class=anchor>🔗</a></h2><p>确保名为 pub 的 slot 不存在</p><p>SELECT slot_name, plugin, slot_type, database, active, restart_lsn, confirmed_flush_lsn FROM pg_replication_slots;</p><p>创建 slot</p><p>docker run -it &ndash;rm &ndash;network lr_default &ndash;link lr-pg1-1:postgres postgres:alpine pg_recvlogical -h pg1 -U dev -d source_rep &ndash;slot=pub &ndash;create-slot -P wal2json</p><p>读取变动</p><p>docker run -it &ndash;rm &ndash;network lr_default &ndash;link lr-pg1-1:postgres postgres:alpine pg_recvlogical -h pg1 -U dev -d source_rep &ndash;slot=pub &ndash;start -o pretty-print=1 -f -</p><h2 id=via-elixir-postgrex-version-0165>via Elixir Postgrex: (version 0.16.5) <a href=#via-elixir-postgrex-version-0165 class=anchor>🔗</a></h2><p>mix new app</p><p>cd app</p><p>in mix.exs: {:postgrex, &ldquo;>=0.0.0&rdquo;}</p><p>参考样例 <a href=https://hexdocs.pm/postgrex/Postgrex.ReplicationConnection.html>https://hexdocs.pm/postgrex/Postgrex.ReplicationConnection.html</a></p><p>原理，启动链接时设置 :replication 为 &ldquo;database&rdquo;. <a href=https://www.postgresql.org/docs/current/protocol-replication.html>READ MORE</a></p><p>如果你按照上边的步骤启动的节点 注意修改 start_link 的参数</p><p>try_pg.exs</p><p>为了访问 lr_default 网络，需要在 app 内 和 lr_default 网络中启动 elixir docker container</p><p>docker run -it &ndash;rm &ndash;network lr_default &ndash;link lr-pg1-1:postgres -v $PWD:/app elixir:alpine sh</p><p>sh#: cd /app</p><p>sh#: mix run try_pg.ex</p><p>默认使用 plugin pgoutput</p><h1 id=wait-bonus-using-wal2json>Wait, Bonus! using wal2json! <a href=#wait-bonus-using-wal2json class=anchor>🔗</a></h1><p>不能简单地将代码中的 pgoutput 替换为 wal2json
还需要将 pgoutput 的参数去掉</p><p>即
START_REPLICATION SLOT postgrex LOGICAL 0/0 (proto_version &lsquo;1&rsquo;, publication_names &lsquo;postgrex_example&rsquo;)
改为
START_REPLICATION SLOT postgrex LOGICAL 0/0 (proto_version &lsquo;1&rsquo;, publication_names &lsquo;postgrex_example&rsquo;)</p><p>如果你希望使用 <a href=https://github.com/eulerto/wal2json#parameters>wal2json 参数</a> 需要修改 query.</p><p>简单示例:</p><p>query = ~s{START_REPLICATION SLOT postgrex LOGICAL 0/0 (&ldquo;pretty-print&rdquo; &rsquo;true&rsquo;, &ldquo;add-msg-prefixes&rdquo; &lsquo;wal2json&rsquo;)}</p><p>如果有任何错误考虑进行本地debug</p><p>修改 mix.exs 中 为</p><p>{:postgrex, &ldquo;>= 0.0.0&rdquo;},
{:postgrex, path: &ldquo;deps/postgrex&rdquo;},</p><p>找到 handle/5 中</p><p>{:noreply, %{s | protocol: protocol, streaming: max_messages}} 下方添加 dbg()</p><p>即可通过执行</p><p>mix run try_pg.exs 查看 wal2json 参数错误信息</p><p>例如</p><p>reason: %Postgrex.Error{
message: nil,
postgres: %{
code: :invalid_parameter_value,
file: &ldquo;wal2json.c&rdquo;,
line: &ldquo;730&rdquo;,
message: &ldquo;option "pretty_print" = "1" is unknown&rdquo;,
pg_code: &ldquo;22023&rdquo;,
routine: &ldquo;pg_decode_startup&rdquo;,
severity: &ldquo;ERROR&rdquo;,
unknown: &ldquo;ERROR&rdquo;,
where: &ldquo;slot "postgrex", output plugin "wal2json", in the startup callback&rdquo;
},
connection_id: 3405,
query: nil
},</p><p>That&rsquo;s it.</p><p>Have fun with Logical Decoding in Elixir!</p><p>WARNING:</p><p><a href=https://www.postgresql.org/docs/current/protocol-replication.html>https://www.postgresql.org/docs/current/protocol-replication.html</a></p><p>Postgrex.ReplicationConnection
this module is experimental and may be subject to changes in the future.</p><p>Refs:</p><p><a href=https://www.postgresql.org/docs/current/logical-replication.html>https://www.postgresql.org/docs/current/logical-replication.html</a>
<a href=https://www.postgresql.org/docs/current/wal-internals.html>https://www.postgresql.org/docs/current/wal-internals.html</a>
<a href=https://www.postgresql.org/docs/current/protocol-replication.html>https://www.postgresql.org/docs/current/protocol-replication.html</a></p><p><a href=https://github.com/eulerto/wal2json/issues/165>https://github.com/eulerto/wal2json/issues/165</a></p></div><hr><script src=https://utteranc.es/client.js repo=supeterlau/supeterlau.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></section></div><div class=side><div class=side-recent><h2 class=side-title>Recent Posts</h2><hr><ul><li><a href=/zh/posts/postgresql-logical-replication-with-docker-and-elixir/>PostgreSQL Logical Replication with Docker and Elixir</a></li></ul></div><div class=side-categories><h2>Categories</h2><hr><ul><li><a href=/categories/dev>dev(1)</a></li></ul></div><div class=side-tags><h2>Tags</h2><hr><ul><li><a href=/tags/docker>docker (1)</a></li><li><a href=/tags/elixir>elixir (1)</a></li><li><a href=/tags/pg>pg (1)</a></li></ul></div></div></main><footer class=footer><div class=footer-row><a class=footer-item href=https://www.peterlau.xyz/zh/posts/index.xml>Feed of Posts
<i class=icofont-rss></i></a></div><div class=footer-row><span class=footer-item>Copyright <a href=https://creativecommons.org/licenses/by/4.0/>CC BY-4.0</a> 2024</span></div><div class=footer-row><span class=footer-item>Powered by <a href=https://gohugo.io>Hugo</a></span>
<span class=footer-item>Theme <a href=https://github.com/leafee98/hugo-theme-flat>hugo-theme-flat</a></span></div></footer></body></html>