<!doctype html><html><head><title>PostgreSQL Logical Replication with Docker and Elixir | ç é›¾</title><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=keywords content="pg,elixir,docker"><meta name=description content="postgresql, logical replication, docker, elixir, wal2json"><link rel=stylesheet href=/lib/icofont/icofont.min.css><link rel=stylesheet href=/css/syntax.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-YEDG0XLC2T"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YEDG0XLC2T")</script><body><header class=header-wrapper><div class=header><a class=site-title href=https://www.peterlau.xyz>ç é›¾</a><div class=menu><ul class=menu-left><li class=menu-item><a href=/posts/>Posts</a></li><li class=menu-item>"I saw the best minds of my generation destroyed by madness"</li></ul><div class=menu-right><li class=menu-item><a href>Contact</a></li></div></div></div></header><main class=main-wrapper><div class=main><section class=single><h1 class=title>PostgreSQL Logical Replication with Docker and Elixir</h1><div class=tip><time datetime="2022-09-29 00:00:00 +0000 UTC">2022/09/29</time>
<span class=split>Â·</span>
<span>619 words</span>
<span class=split>Â·</span>
<span>2 minutes to read</span></div><div class=taxonomies><div>Categories:
<a href=/categories/dev>dev</a></div><div>Tags:
<a href=/tags/pg>pg</a>
<a href=/tags/elixir>elixir</a>
<a href=/tags/docker>docker</a></div></div><hr><div class=content><h1 id=å¯åŠ¨ä¸¤ä¸ª-pg-èŠ‚ç‚¹-using-docker-compose>å¯åŠ¨ä¸¤ä¸ª pg èŠ‚ç‚¹ (using Docker Compose) <a href=#%e5%90%af%e5%8a%a8%e4%b8%a4%e4%b8%aa-pg-%e8%8a%82%e7%82%b9-using-docker-compose class=anchor>ğŸ”—</a></h1><p>(lr aka Logical Replication)
mkdir lr</p><p>mkdir -p pg1/{data,share} pg2/{data,share}</p><p>touch docker-compose.yml</p><p>content:</p><p>start compose:</p><p>docker-compose up</p><p>æ„Ÿè°¢ Debezium çš„ <a href=https://github.com/debezium/container-images/tree/main/postgres/14-alpine>postgresql-alpine-with-wal2json image</a> è®©å®‰è£… wal2json å¾ˆå®¹æ˜“.</p><p>ä»å®¹å™¨ä¸­å¤åˆ¶ä¸€ä»½ pg_hba.conf.example åˆ° ./pg1/share/pg_hda.conf å’Œ ./pg2/share/pg_hda.conf</p><p>start a new terminal:</p><p>cd lr</p><p>docker cp lr-pg1-1:/usr/local/share/postgresql/pg_hba.conf.sample lr/pg1/share/pg_hba.conf</p><p>docker cp lr-pg1-1:/usr/local/share/postgresql/pg_hba.conf.sample lr/pg2/share/pg_hba.conf</p><p>æœ«å°¾æ·»åŠ </p><p>host all repuser 0.0.0.0/0 md5</p><p>restart docker-compose</p><p>Ctrl-c</p><p>docker-compose up</p><p>æŸ¥çœ‹ pg2 Log: docker-compose logs -f pg2</p><h1 id=logical-decoding>Logical Decoding <a href=#logical-decoding class=anchor>ğŸ”—</a></h1><h2 id=create-tables-and-data>Create tables and data <a href=#create-tables-and-data class=anchor>ğŸ”—</a></h2><p>In pg1 as publication</p><p>create database source_rep;
\c source_rep;
create table test_rep(id int primary key, name varchar);
create table test_rep_other(id int primary key, name varchar);
insert into test_rep values(generate_series(1,100),&lsquo;data&rsquo;||generate_series(1,100));
insert into test_rep_other values(generate_series(1,100),&lsquo;data&rsquo;||generate_series(1,100));
select count(1) from test_rep;
select count(1) from test_rep_other;</p><p>åˆ›å»º PUBLICATION
CREATE PUBLICATION pub FOR TABLE test_rep, test_rep_other;</p><p>In pg2 as subscription</p><p>create database target_rep;
create table test_rep(id int primary key, name varchar);
create table test_rep_other(id int primary key, name varchar);</p><p>åˆ›å»º SUBSCRIPTION</p><p>CREATE SUBSCRIPTION sub CONNECTION &lsquo;dbname=source_rep host=pg1 user=dev password=dev port=5432&rsquo; PUBLICATION pub;</p><p>ä¸€ä¸ªå¸¸ç”¨è¯­å¥ check solts</p><p>SELECT slot_name, plugin, slot_type, database, active, restart_lsn, confirmed_flush_lsn FROM pg_replication_slots;</p><h2 id=via-sql>via SQL: <a href=#via-sql class=anchor>ğŸ”—</a></h2><h2 id=via-pg_recvlogical>via pg_recvlogical: <a href=#via-pg_recvlogical class=anchor>ğŸ”—</a></h2><p>ç¡®ä¿åä¸º pub çš„ slot ä¸å­˜åœ¨</p><p>SELECT slot_name, plugin, slot_type, database, active, restart_lsn, confirmed_flush_lsn FROM pg_replication_slots;</p><p>åˆ›å»º slot</p><p>docker run -it &ndash;rm &ndash;network lr_default &ndash;link lr-pg1-1:postgres postgres:alpine pg_recvlogical -h pg1 -U dev -d source_rep &ndash;slot=pub &ndash;create-slot -P wal2json</p><p>è¯»å–å˜åŠ¨</p><p>docker run -it &ndash;rm &ndash;network lr_default &ndash;link lr-pg1-1:postgres postgres:alpine pg_recvlogical -h pg1 -U dev -d source_rep &ndash;slot=pub &ndash;start -o pretty-print=1 -f -</p><h2 id=via-elixir-postgrex-version-0165>via Elixir Postgrex: (version 0.16.5) <a href=#via-elixir-postgrex-version-0165 class=anchor>ğŸ”—</a></h2><p>mix new app</p><p>cd app</p><p>in mix.exs: {:postgrex, &ldquo;>=0.0.0&rdquo;}</p><p>å‚è€ƒæ ·ä¾‹ <a href=https://hexdocs.pm/postgrex/Postgrex.ReplicationConnection.html>https://hexdocs.pm/postgrex/Postgrex.ReplicationConnection.html</a></p><p>åŸç†ï¼Œå¯åŠ¨é“¾æ¥æ—¶è®¾ç½® :replication ä¸º &ldquo;database&rdquo;. <a href=https://www.postgresql.org/docs/current/protocol-replication.html>READ MORE</a></p><p>å¦‚æœä½ æŒ‰ç…§ä¸Šè¾¹çš„æ­¥éª¤å¯åŠ¨çš„èŠ‚ç‚¹ æ³¨æ„ä¿®æ”¹ start_link çš„å‚æ•°</p><p>try_pg.exs</p><p>ä¸ºäº†è®¿é—® lr_default ç½‘ç»œï¼Œéœ€è¦åœ¨ app å†… å’Œ lr_default ç½‘ç»œä¸­å¯åŠ¨ elixir docker container</p><p>docker run -it &ndash;rm &ndash;network lr_default &ndash;link lr-pg1-1:postgres -v $PWD:/app elixir:alpine sh</p><p>sh#: cd /app</p><p>sh#: mix run try_pg.ex</p><p>é»˜è®¤ä½¿ç”¨ plugin pgoutput</p><h1 id=wait-bonus-using-wal2json>Wait, Bonus! using wal2json! <a href=#wait-bonus-using-wal2json class=anchor>ğŸ”—</a></h1><p>ä¸èƒ½ç®€å•åœ°å°†ä»£ç ä¸­çš„ pgoutput æ›¿æ¢ä¸º wal2json
è¿˜éœ€è¦å°† pgoutput çš„å‚æ•°å»æ‰</p><p>å³
START_REPLICATION SLOT postgrex LOGICAL 0/0 (proto_version &lsquo;1&rsquo;, publication_names &lsquo;postgrex_example&rsquo;)
æ”¹ä¸º
START_REPLICATION SLOT postgrex LOGICAL 0/0 (proto_version &lsquo;1&rsquo;, publication_names &lsquo;postgrex_example&rsquo;)</p><p>å¦‚æœä½ å¸Œæœ›ä½¿ç”¨ <a href=https://github.com/eulerto/wal2json#parameters>wal2json å‚æ•°</a> éœ€è¦ä¿®æ”¹ query.</p><p>ç®€å•ç¤ºä¾‹:</p><p>query = ~s{START_REPLICATION SLOT postgrex LOGICAL 0/0 (&ldquo;pretty-print&rdquo; &rsquo;true&rsquo;, &ldquo;add-msg-prefixes&rdquo; &lsquo;wal2json&rsquo;)}</p><p>å¦‚æœæœ‰ä»»ä½•é”™è¯¯è€ƒè™‘è¿›è¡Œæœ¬åœ°debug</p><p>ä¿®æ”¹ mix.exs ä¸­ ä¸º</p><p>{:postgrex, &ldquo;>= 0.0.0&rdquo;},
{:postgrex, path: &ldquo;deps/postgrex&rdquo;},</p><p>æ‰¾åˆ° handle/5 ä¸­</p><p>{:noreply, %{s | protocol: protocol, streaming: max_messages}} ä¸‹æ–¹æ·»åŠ  dbg()</p><p>å³å¯é€šè¿‡æ‰§è¡Œ</p><p>mix run try_pg.exs æŸ¥çœ‹ wal2json å‚æ•°é”™è¯¯ä¿¡æ¯</p><p>ä¾‹å¦‚</p><p>reason: %Postgrex.Error{
message: nil,
postgres: %{
code: :invalid_parameter_value,
file: &ldquo;wal2json.c&rdquo;,
line: &ldquo;730&rdquo;,
message: &ldquo;option "pretty_print" = "1" is unknown&rdquo;,
pg_code: &ldquo;22023&rdquo;,
routine: &ldquo;pg_decode_startup&rdquo;,
severity: &ldquo;ERROR&rdquo;,
unknown: &ldquo;ERROR&rdquo;,
where: &ldquo;slot "postgrex", output plugin "wal2json", in the startup callback&rdquo;
},
connection_id: 3405,
query: nil
},</p><p>That&rsquo;s it.</p><p>Have fun with Logical Decoding in Elixir!</p><p>WARNING:</p><p><a href=https://www.postgresql.org/docs/current/protocol-replication.html>https://www.postgresql.org/docs/current/protocol-replication.html</a></p><p>Postgrex.ReplicationConnection
this module is experimental and may be subject to changes in the future.</p><p>Refs:</p><p><a href=https://www.postgresql.org/docs/current/logical-replication.html>https://www.postgresql.org/docs/current/logical-replication.html</a>
<a href=https://www.postgresql.org/docs/current/wal-internals.html>https://www.postgresql.org/docs/current/wal-internals.html</a>
<a href=https://www.postgresql.org/docs/current/protocol-replication.html>https://www.postgresql.org/docs/current/protocol-replication.html</a></p><p><a href=https://github.com/eulerto/wal2json/issues/165>https://github.com/eulerto/wal2json/issues/165</a></p></div><hr><script src=https://utteranc.es/client.js repo=supeterlau/supeterlau.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></section></div><div class=side><div class=side-recent><h2 class=side-title>Recent Posts</h2><hr><ul><li><a href=/zh/posts/postgresql-logical-replication-with-docker-and-elixir/>PostgreSQL Logical Replication with Docker and Elixir</a></li></ul></div><div class=side-categories><h2>Categories</h2><hr><ul><li><a href=/categories/dev>dev(1)</a></li></ul></div><div class=side-tags><h2>Tags</h2><hr><ul><li><a href=/tags/docker>docker (1)</a></li><li><a href=/tags/elixir>elixir (1)</a></li><li><a href=/tags/pg>pg (1)</a></li></ul></div></div></main><footer class=footer><div class=footer-row><a class=footer-item href=https://www.peterlau.xyz/zh/posts/index.xml>Feed of Posts
<i class=icofont-rss></i></a></div><div class=footer-row><span class=footer-item>Copyright <a href=https://creativecommons.org/licenses/by/4.0/>CC BY-4.0</a> 2024</span></div><div class=footer-row><span class=footer-item>Powered by <a href=https://gohugo.io>Hugo</a></span>
<span class=footer-item>Theme <a href=https://github.com/leafee98/hugo-theme-flat>hugo-theme-flat</a></span></div></footer></body></html>