<!doctype html><html><head><title>PostgreSQL Logical Replication with Docker and Elixir | CodeMist</title><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><link rel=stylesheet href=/lib/icofont/icofont.min.css><link rel=stylesheet href=/css/syntax.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><header class=header-wrapper><div class=header><a class=site-title href=https://www.peterlau.xyz>CodeMist</a><div class=menu><ul class=menu-left><li class=menu-item><a href=/posts/>Posts</a></li><li class=menu-item>"I saw the best minds of my generation destroyed by madness"</li></ul><div class=menu-right><li class=menu-item><a href=/contact/>Contact</a></li></div></div></div></header><main class=main-wrapper><div class=main><section class=single><h1 class=title>PostgreSQL Logical Replication with Docker and Elixir</h1><div class=tip><time datetime="2022-09-29 00:00:00 +0000 UTC">2022/09/29</time>
<span class=split>Â·</span>
<span>773 words</span>
<span class=split>Â·</span>
<span>4 minutes to read</span></div><div class=taxonomies><div>Categories:
<a href=/categories/dev>dev</a></div><div>Tags:
<a href=/tags/pg>pg</a>
<a href=/tags/elixir>elixir</a>
<a href=/tags/docker>docker</a></div></div><hr><div class=content><p>Start PostgreSQL Logical Replication and wal2json plug-in in Docker, and read the changes with Elixir Postgrex.</p><h2 id=start-two-postgresql-nodes-using-docker-compose>Start two PostgreSQL nodes (using Docker Compose) <a href=#start-two-postgresql-nodes-using-docker-compose class=anchor>ðŸ”—</a></h2><p>(lr aka Logical Replication)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir lr
</span></span><span class=line><span class=cl>mkdir -p pg1/<span class=o>{</span>data,share<span class=o>}</span> pg2/<span class=o>{</span>data,share<span class=o>}</span>
</span></span><span class=line><span class=cl>touch docker-compose.yml 
</span></span></code></pre></div><p>docker-compose.yml:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pg1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>debezium/postgres:14-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=l>./pg1/share/pg_hba.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>target</span><span class=p>:</span><span class=w> </span><span class=l>/usr/local/share/postgresql/pg_hba.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./pg1/data:/var/lib/postgresql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_DB</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_USER</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pg2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>debezium/postgres:14-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=l>./pg2/share/pg_hba.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>target</span><span class=p>:</span><span class=w> </span><span class=l>/usr/local/share/postgresql/pg_hba.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./pg2/data:/var/lib/postgresql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_DB</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_USER</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span></code></pre></div><p>Start Docker-compose:</p><p><code>docker-compose up</code></p><p>Thanks to Debezium&rsquo;s <a href=https://github.com/debezium/container-images/tree/main/postgres/14-alpine>postgresql-alpine-with-wal2json image</a>, installing Wal2JSON is extremely easy.</p><p>Last thing, copy <code>pg_hba.conf.example</code> from the container to <code>./pg1/share/pg_hda.conf</code> and <code>./pg2/share/pg_hda.conf</code></p><p>open a new terminal:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> lr 
</span></span><span class=line><span class=cl>docker cp lr-pg1-1:/usr/local/share/postgresql/pg_hba.conf.sample lr/pg1/share/pg_hba.conf
</span></span><span class=line><span class=cl>docker cp lr-pg1-1:/usr/local/share/postgresql/pg_hba.conf.sample lr/pg2/share/pg_hba.conf
</span></span></code></pre></div><p>At the end of files, add</p><p><code>host all repuser 0.0.0.0/0 md5</code></p><p>restart Docker-Compose:</p><p>press Ctrl-c</p><p><code>docker-compose up</code></p><p>Viewing Service pg2 Logs:</p><p><code>docker-compose logs -f pg2</code></p><h2 id=logical-decoding>Logical Decoding <a href=#logical-decoding class=anchor>ðŸ”—</a></h2><h3 id=create-tables-for-pg1pg2-and-add-data>Create tables for pg1/pg2 and add data <a href=#create-tables-for-pg1pg2-and-add-data class=anchor>ðŸ”—</a></h3><p>In pg1 as publication</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>create database source_rep<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=se>\c</span> source_rep<span class=p>;</span>
</span></span><span class=line><span class=cl>create table test_rep<span class=o>(</span>id int primary key, name varchar<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>create table test_rep_other<span class=o>(</span>id int primary key, name varchar<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>insert into test_rep values<span class=o>(</span>generate_series<span class=o>(</span>1,100<span class=o>)</span>,<span class=s1>&#39;data&#39;</span><span class=o>||</span>generate_series<span class=o>(</span>1,100<span class=o>))</span><span class=p>;</span>
</span></span><span class=line><span class=cl>insert into test_rep_other  values<span class=o>(</span>generate_series<span class=o>(</span>1,100<span class=o>)</span>,<span class=s1>&#39;data&#39;</span><span class=o>||</span>generate_series<span class=o>(</span>1,100<span class=o>))</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>select</span> count<span class=o>(</span>1<span class=o>)</span> from test_rep<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>select</span> count<span class=o>(</span>1<span class=o>)</span> from test_rep_other<span class=p>;</span>
</span></span></code></pre></div><p>create PUBLICATION</p><p><code>CREATE PUBLICATION pub FOR TABLE test_rep, test_rep_other;</code></p><p>In pg2 as subscription</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>create database target_rep<span class=p>;</span>
</span></span><span class=line><span class=cl>create table test_rep<span class=o>(</span>id int primary key, name varchar<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>create table test_rep_other<span class=o>(</span>id int primary key, name varchar<span class=o>)</span><span class=p>;</span>
</span></span></code></pre></div><p>create SUBSCRIPTION</p><p><code>CREATE SUBSCRIPTION sub CONNECTION 'dbname=source_rep host=pg1 user=dev password=dev port=5432' PUBLICATION pub;</code></p><p>view Logical Decoding slots:</p><p><code>SELECT slot_name, plugin, slot_type, database, active, restart_lsn, confirmed_flush_lsn FROM pg_replication_slots;</code></p><h3 id=via-sql>via SQL: <a href=#via-sql class=anchor>ðŸ”—</a></h3><p><a href=https://www.postgresql.org/docs/current/logical-replication.html>https://www.postgresql.org/docs/current/logical-replication.html</a></p><h3 id=via-pg_recvlogical>via pg_recvlogical: <a href=#via-pg_recvlogical class=anchor>ðŸ”—</a></h3><p>Make sure the slot named pub not exist</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SELECT slot_name, plugin, slot_type, database, active, restart_lsn, confirmed_flush_lsn FROM pg_replication_slots<span class=p>;</span>
</span></span></code></pre></div><p>create slot</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -it --rm --network lr_default --link lr-pg1-1:postgres postgres:alpine pg_recvlogical -h pg1 -U dev -d source_rep --slot<span class=o>=</span>pub --create-slot -P wal2json<span class=p>;</span>
</span></span></code></pre></div><p>Read the changes</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -it --rm --network lr_default --link lr-pg1-1:postgres postgres:alpine pg_recvlogical -h pg1 -U dev -d source_rep --slot<span class=o>=</span>pub --start -o pretty-print<span class=o>=</span><span class=m>1</span> -f -
</span></span></code></pre></div><h3 id=via-elixir-postgrex-version-0165>via Elixir Postgrex: (version 0.16.5) <a href=#via-elixir-postgrex-version-0165 class=anchor>ðŸ”—</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mix new app
</span></span><span class=line><span class=cl><span class=nb>cd</span> app
</span></span></code></pre></div><p>in mix.exs: {:postgrex, &ldquo;>=0.0.0&rdquo;}</p><p>Refer to the sample <a href=https://hexdocs.pm/postgrex/Postgrex.ReplicationConnection.html>https://hexdocs.pm/postgrex/Postgrex.ReplicationConnection.html</a></p><p>set :replication to &ldquo;database&rdquo; when start_link. <a href=https://www.postgresql.org/docs/current/protocol-replication.html>READ MORE</a></p><p>If you start nodes as described above, be careful to modify the start_link parameter.</p><p>try_pg.exs</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>Repl</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=kn>use</span> <span class=nc>Postgrex.ReplicationConnection</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>start_link</span><span class=p>(</span><span class=n>opts</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=c1># Automatically reconnect if we lose connection.</span>
</span></span><span class=line><span class=cl>    <span class=n>extra_opts</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=ss>auto_reconnect</span><span class=p>:</span> <span class=no>true</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nc>Postgrex.ReplicationConnection</span><span class=o>.</span><span class=n>start_link</span><span class=p>(</span><span class=n>__MODULE__</span><span class=p>,</span> <span class=ss>:ok</span><span class=p>,</span> <span class=n>extra_opts</span> <span class=o>++</span> <span class=n>opts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nc>IO</span><span class=o>.</span><span class=n>inspect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>@impl</span> <span class=no>true</span>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>init</span><span class=p>(</span><span class=ss>:ok</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=ss>:ok</span><span class=p>,</span> <span class=p>%{</span><span class=ss>step</span><span class=p>:</span> <span class=ss>:disconnected</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>@impl</span> <span class=no>true</span>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>handle_connect</span><span class=p>(</span><span class=n>state</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;CREATE_REPLICATION_SLOT postgrex TEMPORARY LOGICAL pgoutput NOEXPORT_SNAPSHOT&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=ss>:query</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=p>%{</span><span class=n>state</span> <span class=o>|</span> <span class=ss>step</span><span class=p>:</span> <span class=ss>:create_slot</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>@impl</span> <span class=no>true</span>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>handle_result</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=p>%{</span><span class=ss>step</span><span class=p>:</span> <span class=ss>:create_slot</span><span class=p>}</span> <span class=o>=</span> <span class=n>state</span><span class=p>)</span> <span class=ow>when</span> <span class=n>is_list</span><span class=p>(</span><span class=n>results</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;START_REPLICATION SLOT postgrex LOGICAL 0/0 (proto_version &#39;1&#39;, publication_names &#39;postgrex_example&#39;)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=ss>:stream</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=p>[],</span> <span class=p>%{</span><span class=n>state</span> <span class=o>|</span> <span class=ss>step</span><span class=p>:</span> <span class=ss>:streaming</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>@impl</span> <span class=no>true</span>
</span></span><span class=line><span class=cl>  <span class=c1># https://www.postgresql.org/docs/14/protocol-replication.html</span>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>handle_data</span><span class=p>(&lt;&lt;</span><span class=sc>?w</span><span class=p>,</span> <span class=n>_wal_start</span><span class=o>::</span><span class=mi>64</span><span class=p>,</span> <span class=n>_wal_end</span><span class=o>::</span><span class=mi>64</span><span class=p>,</span> <span class=n>_clock</span><span class=o>::</span><span class=mi>64</span><span class=p>,</span> <span class=n>rest</span><span class=o>::</span><span class=n>binary</span><span class=p>&gt;&gt;,</span> <span class=n>state</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nc>IO</span><span class=o>.</span><span class=n>inspect</span><span class=p>(</span><span class=n>rest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=ss>:noreply</span><span class=p>,</span> <span class=n>state</span><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>handle_data</span><span class=p>(&lt;&lt;</span><span class=sc>?k</span><span class=p>,</span> <span class=n>wal_end</span><span class=o>::</span><span class=mi>64</span><span class=p>,</span> <span class=n>_clock</span><span class=o>::</span><span class=mi>64</span><span class=p>,</span> <span class=n>reply</span><span class=p>&gt;&gt;,</span> <span class=n>state</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>reply</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=mi>1</span> <span class=o>-&gt;</span> <span class=p>[&lt;&lt;</span><span class=sc>?r</span><span class=p>,</span> <span class=n>wal_end</span> <span class=o>+</span> <span class=mi>1</span><span class=o>::</span><span class=mi>64</span><span class=p>,</span> <span class=n>wal_end</span> <span class=o>+</span> <span class=mi>1</span><span class=o>::</span><span class=mi>64</span><span class=p>,</span> <span class=n>wal_end</span> <span class=o>+</span> <span class=mi>1</span><span class=o>::</span><span class=mi>64</span><span class=p>,</span> <span class=n>current_time</span><span class=p>()</span><span class=o>::</span><span class=mi>64</span><span class=p>,</span> <span class=mi>0</span><span class=p>&gt;&gt;]</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span> <span class=o>-&gt;</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=ss>:noreply</span><span class=p>,</span> <span class=n>messages</span><span class=p>,</span> <span class=n>state</span><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>@epoch</span> <span class=nc>DateTime</span><span class=o>.</span><span class=n>to_unix</span><span class=p>(</span><span class=sx>~U[2000-01-01 00:00:00Z]</span><span class=p>,</span> <span class=ss>:microsecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>defp</span> <span class=n>current_time</span><span class=p>(),</span> <span class=ss>do</span><span class=p>:</span> <span class=nc>System</span><span class=o>.</span><span class=n>os_time</span><span class=p>(</span><span class=ss>:microsecond</span><span class=p>)</span> <span class=o>-</span> <span class=na>@epoch</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=ss>:ok</span><span class=p>,</span> <span class=n>_pid</span><span class=p>}</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=nc>Repl</span><span class=o>.</span><span class=n>start_link</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=ss>hostname</span><span class=p>:</span> <span class=s2>&#34;postgres&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>database</span><span class=p>:</span> <span class=s2>&#34;source_rep&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>username</span><span class=p>:</span> <span class=s2>&#34;dev&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>password</span><span class=p>:</span> <span class=s2>&#34;dev&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nc>Process</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=ss>:infinity</span><span class=p>)</span>
</span></span></code></pre></div><p>To access the lr_default network in docker, start a Elixir Docker Container in path /app and link to the lr_default network:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -it --rm --network lr_default --link lr-pg1-1:postgres -v <span class=nv>$PWD</span>:/app elixir:alpine sh
</span></span><span class=line><span class=cl>sh#: <span class=nb>cd</span> /app
</span></span><span class=line><span class=cl>sh#: mix run try_pg.ex
</span></span></code></pre></div><p>using plugin pgoutput by default.</p><h2 id=wait-bonus-using-wal2json>Wait, Bonus! using wal2json! <a href=#wait-bonus-using-wal2json class=anchor>ðŸ”—</a></h2><p>You cannot simply replace pgoutput with wal2json in your code.</p><p>At least the parameters of pgoutput need to be removed.</p><p>Change</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=nc>START_REPLICATION</span> <span class=nc>SLOT</span> <span class=n>postgrex</span> <span class=nc>LOGICAL</span> <span class=mi>0</span><span class=o>/</span><span class=mi>0</span> <span class=p>(</span><span class=n>proto_version</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=n>publication_names</span> <span class=s1>&#39;postgrex_example&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=nc>START_REPLICATION</span> <span class=nc>SLOT</span> <span class=n>postgrex</span> <span class=nc>LOGICAL</span> <span class=mi>0</span><span class=o>/</span><span class=mi>0</span> <span class=p>(</span><span class=n>proto_version</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=n>publication_names</span> <span class=s1>&#39;postgrex_example&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>If you want to use <a href=https://github.com/eulerto/wal2json#parameters>wal2json parameters</a>, you need to modify the query at the same time.</p><p>Example of simple parameters:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=sx>~s{START_REPLICATION SLOT postgrex LOGICAL 0/0 (&#34;pretty-print&#34; &#39;true&#39;, &#34;add-msg-prefixes&#34; &#39;wal2json&#39;)}</span>
</span></span></code></pre></div><p>Consider local debugging if there are any errors</p><p>modify mix.exs</p><p><code>{:postgrex, ">= 0.0.0"},</code></p><p>to</p><p><code>{:postgrex, path: "deps/postgrex"},</code></p><p>find <code>deps/postgrex/lib/postgrex/replication_connection.ex</code> function handle/5 (v0.16.5 L540)</p><p><code>{:noreply, %{s | protocol: protocol, streaming: max_messages}}</code></p><p>below that, you can add</p><p><code>dbg()</code></p><p>By executing</p><p><code>mix run try_pg.exs</code></p><p>to View wal2json error information.</p><p>Error example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl>  <span class=ss>reason</span><span class=p>:</span> <span class=p>%</span><span class=nc>Postgrex.Error</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=ss>message</span><span class=p>:</span> <span class=no>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>postgres</span><span class=p>:</span> <span class=p>%{</span>
</span></span><span class=line><span class=cl>      <span class=ss>code</span><span class=p>:</span> <span class=ss>:invalid_parameter_value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>file</span><span class=p>:</span> <span class=s2>&#34;wal2json.c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>line</span><span class=p>:</span> <span class=s2>&#34;730&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>message</span><span class=p>:</span> <span class=s2>&#34;option \&#34;pretty_print\&#34; = \&#34;1\&#34; is unknown&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>pg_code</span><span class=p>:</span> <span class=s2>&#34;22023&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>routine</span><span class=p>:</span> <span class=s2>&#34;pg_decode_startup&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>severity</span><span class=p>:</span> <span class=s2>&#34;ERROR&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>unknown</span><span class=p>:</span> <span class=s2>&#34;ERROR&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>where</span><span class=p>:</span> <span class=s2>&#34;slot \&#34;postgrex\&#34;, output plugin \&#34;wal2json\&#34;, in the startup callback&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=ss>connection_id</span><span class=p>:</span> <span class=mi>3405</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>query</span><span class=p>:</span> <span class=no>nil</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span></code></pre></div><p>That&rsquo;s it.</p><p>Have fun with Logical Decoding with Docker and Elixir !</p><h2 id=warning>WARNING: <a href=#warning class=anchor>ðŸ”—</a></h2><p><a href=https://www.postgresql.org/docs/current/protocol-replication.html>https://www.postgresql.org/docs/current/protocol-replication.html</a></p><p>Postgrex.ReplicationConnection</p><p><em>this module is experimental and may be subject to changes in the future.</em></p><h2 id=refs>Refs: <a href=#refs class=anchor>ðŸ”—</a></h2><p><a href=https://www.postgresql.org/docs/current/logical-replication.html>https://www.postgresql.org/docs/current/logical-replication.html</a>
<a href=https://www.postgresql.org/docs/current/wal-internals.html>https://www.postgresql.org/docs/current/wal-internals.html</a>
<a href=https://www.postgresql.org/docs/current/protocol-replication.html>https://www.postgresql.org/docs/current/protocol-replication.html</a></p></div><hr><script src=https://utteranc.es/client.js repo=supeterlau/supeterlau.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></section></div><div class=side><div class=side-recent><h2 class=side-title>Recent Posts</h2><hr><ul><li><a href=/posts/hugo/>Hugo</a></li><li><a href=/posts/postgresql-logical-replication-with-docker-and-elixir/>PostgreSQL Logical Replication with Docker and Elixir</a></li></ul></div><div class=side-categories><h2>Categories</h2><hr><ul><li><a href=/categories/dev>dev(1)</a></li><li><a href=/categories/note>note(1)</a></li></ul></div><div class=side-tags><h2>Tags</h2><hr><ul><li><a href=/tags/docker>docker (1)</a></li><li><a href=/tags/elixir>elixir (1)</a></li><li><a href=/tags/hugo>hugo (1)</a></li><li><a href=/tags/jamstack>jamstack (1)</a></li><li><a href=/tags/pg>pg (1)</a></li><li><a href=/tags/ssg>ssg (1)</a></li></ul></div></div></main><footer class=footer><div class=footer-row><a class=footer-item href=https://www.peterlau.xyz/posts/index.xml>Feed of Posts
<i class=icofont-rss></i></a></div><div class=footer-row><span class=footer-item>Copyright <a href=https://creativecommons.org/licenses/by/4.0/>CC BY-4.0</a> 2022</span></div><div class=footer-row><span class=footer-item>Powered by <a href=https://gohugo.io>Hugo</a></span>
<span class=footer-item>Theme <a href=https://github.com/leafee98/hugo-theme-flat>hugo-theme-flat</a></span></div></footer></body></html>